<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XIOMA FX ‚Äî Order Administration (Demo)</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --line2:#d1d5db;
      --blue:#2563eb;
      --blue2:#1d4ed8;
      --chip:#f3f4f6;
      --chipText:#374151;
      --shadow: 0 1px 2px rgba(0,0,0,.04);
      --radius: 10px;
      --radius2: 8px;
      --client-col-max: 260px; /* Client Name: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã + ellipsis */
      /* Subtle order-book highlighting */
      --sell-bg:#fff1f2;   /* light reddish/pink */
      --sell-border:#fecdd3;
      --buy-bg:#f0fdf4;    /* light greenish */
      --buy-border:#bbf7d0;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }
    *{box-sizing:border-box}
    html, body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:var(--bg);
      overflow:hidden; /* —Å–∫—Ä–æ–ª–ª–∏–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ–±–ª–∞—Å—Ç–∏ (—Ç–∞–±–ª–∏—Ü–∞/—Å–∞–π–¥–±–∞—Ä), –∞ –Ω–µ –≤—Å—é —Å—Ç—Ä–∞–Ω–∏—Ü—É */
    }
    a{color:inherit; text-decoration:none}
    /* Top nav */
    .topbar{
      height:56px;
      background:var(--card);
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      padding:0 18px;
      gap:18px;
    }
    .brand{
      font-weight:800;
      letter-spacing:.2px;
      color:#0b3bff;
    }
    .menu{display:flex; gap:16px; align-items:center; color:#111827}
    .menu .item{font-weight:600; font-size:14px; color:#111827}
    .menu .item .caret{font-size:12px; color:var(--muted); margin-left:6px}
    .spacer{flex:1}
    .user{
      font-size:14px;
      color:#111827;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .icon-btn{
      width:32px; height:32px;
      border:1px solid var(--line);
      background:#fff;
      border-radius:8px;
      display:grid; place-items:center;
      cursor:pointer;
    }
    .icon{font-size:16px; color:var(--muted)}
    /* Page */
    .page{
      padding:18px;
      height:calc(100vh - 56px); /* topbar = 56px */
      overflow:hidden;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      height:100%;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .header{
      padding:16px 16px 10px 16px;
      display:flex;
      align-items:flex-start;
      gap:16px;
    }
    .hgroup{display:flex; flex-direction:column; gap:8px}
    .title{
      font-size:18px;
      font-weight:800;
      margin:0;
    }
    .subline{
      display:flex; align-items:center; gap:10px;
      color:var(--muted);
      font-size:13px;
    }
    /* Switch */
    .switch{
      position:relative; width:38px; height:20px;
      background:#d1d5db;
      border-radius:999px;
      cursor:pointer;
      display:inline-block;
      vertical-align:middle;
    }
    .switch::after{
      content:"";
      position:absolute; top:2px; left:2px;
      width:16px; height:16px;
      background:#fff;
      border-radius:999px;
      transition:all .15s ease;
      box-shadow:0 1px 2px rgba(0,0,0,.12);
    }
    .switch.on{background:#60a5fa}
    .switch.on::after{left:20px}
    /* Mode switch (Monitor / Blotter / History) */
    .mode-switch{
      display:inline-flex;
      align-items:center;
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:3px;
      gap:3px;
    }
    .mode-btn{
      height:28px;
      padding:0 12px;
      border-radius:999px;
      border:1px solid transparent;
      background:transparent;
      color:var(--muted);
      font-size:12px;
      font-weight:800;
      cursor:pointer;
    }
    .mode-btn:hover{
      background:#f3f4f6;
      color:#111827;
    }
    .mode-btn.active{
      background:#eff6ff;
      border-color:#bfdbfe;
      color:var(--blue);
    }
    /* Buttons */
    .btn{
      height:34px;
      padding:0 12px;
      border-radius:8px;
      font-weight:700;
      font-size:13px;
      border:1px solid var(--line2);
      background:#fff;
      color:#111827;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn.primary{
      background:var(--blue);
      color:#fff;
      border-color:var(--blue);
    }
    .btn.primary:hover{background:var(--blue2)}
    .btn.ghost{
      color:var(--blue);
      border-color:#bfdbfe;
      background:#eff6ff;
    }
    .btn.danger{
      background:#fee2e2;
      border-color:#fecaca;
      color:#b91c1c;
    }
    .btn.danger:hover{background:#fecaca}
    .btn.toolbar{
      height:32px;
      padding:0 14px;
      border-radius:999px;
      font-size:12px;
    }
    .btn:active{transform:translateY(1px)}
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
    }
    .btn:disabled:active{
      transform:none;
    }
    /* Filters row */
    .filters-panel{
      margin:0 0 12px 0;
      padding:12px 14px 14px 14px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#ffffff;
      box-shadow:0 1px 0 rgba(15,23,42,0.02);
    }
    .toolbar-panel{
      margin:0 0 12px 0;
      padding:12px 14px 12px 14px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#ffffff;
      box-shadow:0 1px 0 rgba(15,23,42,0.02);
    }
    .filters-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
    }
    /* Filters: split sections (Blotter view) */
    .filters-split-label{
      font-size:12px;
      font-weight:700;
      color:var(--muted);
      margin:0 0 8px 0;
      letter-spacing:0.2px;
    }
    .filters-divider{
      border-top:1px solid var(--line);
      margin:12px 0;
    }
    .applied-filters-row{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .applied-filters-input{
      background:#f9fafb;
      color:#374151;
      flex:1;
      min-width:260px;
    }

    /* Applied filters (status bar) */
    .applied-bar{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius:10px;
      background:#f9fafb;
    }

    .applied-label{
      font-size:12px;
      font-weight:800;
      color:var(--muted);
      white-space:nowrap;
    }

    .applied-text{
      flex:1;
      font-size:12px;
      color:#111827;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      user-select:text;
    }
    .applied-text.is-empty{
      color:var(--muted);
    }
    .toolbar-header{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:10px;
    }
    .section-title{
      font-size:14px;
      font-weight:700;
      color:#374151;
      padding:4px 2px 2px 2px;
      letter-spacing:0.2px;
    }
    .section-subtitle{
      font-size:14px;
      font-weight:500;
      color:#6b7280;
    }
    .filters-grid{
      display:grid;
      grid-template-columns: fit-content(220px) fit-content(260px) fit-content(200px) fit-content(200px) fit-content(220px) auto;
      gap:12px;
      align-items:end;
      justify-content:start;
    }
    .blotter-filters-grid{
      display:grid;
      grid-template-columns: repeat(6, fit-content(240px));
      gap:12px;
      align-items:end;
      justify-content:start;
    }
    .input.with-icon{
      padding-left:30px;
    }
    .field.has-icon{
      position:relative;
    }
    .field-icon{
      position:absolute;
      left:10px;
      bottom:10px;
      color:#9ca3af;
      font-size:14px;
      pointer-events:none;
    }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:700;
    }
    .label-with-icon{
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .label-icon{
      font-size:12px;
      line-height:1;
      color:#b45309;
    }
    .input, .select, .chips{
      height:36px;
      border:1px solid var(--line2);
      border-radius:8px;
      background:#fff;
      padding:0 10px;
      font-size:13px;
      outline:none;
      width:100%;
    }
    .input:focus, .select:focus, .chips:focus-within{
      border-color:#93c5fd;
      box-shadow:0 0 0 3px rgba(59,130,246,.15);
    }
    .chips{
      display:flex;
      align-items:center;
      gap:6px;
      padding:4px 6px;
      overflow:hidden;
    }
    .chip{
      background:var(--chip);
      color:var(--chipText);
      border:1px solid var(--line);
      border-radius:999px;
      padding:4px 8px;
      font-size:12px;
      font-weight:700;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .chip .x{
      width:16px; height:16px;
      border-radius:999px;
      display:grid; place-items:center;
      font-size:12px;
      color:#6b7280;
      cursor:pointer;
    }
    .chip .x:hover{background:#e5e7eb}
    .chips input{
      border:none;
      outline:none;
      font-size:13px;
      min-width:90px;
      flex:1;
    }
    .filter-actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      align-items:center;
    }
    .btn.small{height:34px}
    /* Main layout */
    .content{
      border-top:1px solid var(--line);
      display:grid;
      grid-template-columns: 220px 1fr;
      flex:1;
      min-height:0;   /* –≤–∞–∂–Ω–æ –¥–ª—è flex/grid + –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Å–∫—Ä–æ–ª–ª–æ–≤ */
      overflow:hidden;
    }
    /* When Blotter view is active: sidebar hidden, content full width */
    .content.no-sidebar{
      grid-template-columns: 1fr;
    }
    .main{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      background:#f3f4f6;
      border-radius:12px;
      flex:1;
      min-height:0;   /* –≤–∞–∂–Ω–æ: –∏–Ω–∞—á–µ table-wrap –Ω–µ —Å–º–æ–∂–µ—Ç "—É–∂–∞—Ç—å—Å—è" –∏ –Ω–∞—á–∞—Ç—å —Å–∫—Ä–æ–ª–ª–∏—Ç—å—Å—è */
      overflow:hidden;
    }
    .sidebar{
      border-right:1px solid var(--line);
      padding:12px 0;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .side-title{
      padding:0 14px 10px 14px;
      font-size:14px;
      color:#374151;
      font-weight:700;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .pair-list{
      overflow:auto;
      padding:0 6px;
      flex:1;
      min-height:0;
    }
    .pair{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 10px;
      margin:2px 6px;
      border-radius:10px;
      cursor:pointer;
      font-size:13px;
      border:1px solid transparent;
    }
    .pair-info{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pair .bulb{
      width:16px;
      height:16px;
      font-size:11px;
    }
    .pair:hover{background:#f9fafb; border-color:var(--line)}
    .pair.active{background:#eef2ff; border-color:#c7d2fe}
    .pair .code{font-weight:800}
    .pair .count{color:var(--muted); font-variant-numeric:tabular-nums}
    /* Table toolbar */
    .tablebar{
      padding:10px 12px;
      border-radius:12px;
      display:flex;
      align-items:center;
      gap:10px;
      color:var(--muted);
      font-size:13px;
      background:#fff;
      flex-wrap:wrap;
    }
    /* Order Toolbar grouping */
    .toolbar-group{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .toolbar-selected{
      padding-left:12px;
      border-left:1px solid var(--line);
      margin-left:12px;
    }
    .toolbar-label{
      font-size:12px;
      font-weight:800;
      color:var(--muted);
      white-space:nowrap;
    }
    /* Table */
    .table-wrap{
      overflow:auto;
      border:1px solid var(--line);
      border-radius:12px;
      background:#f3f4f6;
      flex:1;        /* –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—ë –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –º–µ—Å—Ç–æ –ø–æ–¥ —Ç—É–ª–±–∞—Ä–∞–º–∏ */
      min-height:0;  /* –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø–æ—è–≤–ª–µ–Ω–∏—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞ */
    }

    /* Views: —á—Ç–æ–±—ã table-wrap –º–æ–≥ –±—ã—Ç—å flex:1 –≤–Ω—É—Ç—Ä–∏ —Ä–µ–∂–∏–º–∞ */
    #monitorView,
    #blotterView,
    #historyView{
      display:flex;
      flex-direction:column;
      flex:1;
      min-height:0;
    }
    table{
      width:max-content;
      border-collapse:separate;
      border-spacing:0;
      min-width:0;
      font-size:13px;
      table-layout:auto;
    }
    col.col-checkbox{width:28px}
    col.col-captured{width:auto}
    col.col-createdby{width:auto}
    col.col-inn{width:auto}
    col.col-client{width:var(--client-col-max)}
    col.col-tif{width:auto}
    col.col-valid{width:auto}
    col.col-sell{width:auto}
    col.col-rate{width:auto}
    /* default touch column width: keep auto (Monitor has no ‚è∑, so it will be compact naturally) */
    col.col-touch{width:auto}
    col.col-buy{width:auto}
    col.col-exposure{width:auto}
    col.col-status{width:auto}
    col.col-actions{width:36px}
    thead th{
      position:sticky;
      top:0;
      background:#fff;
      z-index:2;
      text-align:left;
      color:#111827;
      font-weight:800;
      border-bottom:1px solid var(--line);
      padding:10px 10px;
      white-space:nowrap;
    }
    thead th,
    tbody td{
      border-right:1px solid var(--line);
    }
    thead th:last-child,
    tbody td:last-child{
      border-right:none;
    }
    tbody td{
      border-bottom:1px solid var(--line);
      padding:10px 10px;
      white-space:nowrap;
      color:#111827;
      vertical-align:middle;
    }
    .orders-table th:nth-child(2),
    .orders-table td:nth-child(2){
      padding-left:6px;
      padding-right:6px;
    }
    thead th,
    tbody td{
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Client Name: —Ñ–∏–∫—Å–∏—Ä—É–µ–º –≤–∫–ª–∞–¥ –∫–æ–ª–æ–Ω–∫–∏ –≤ —à–∏—Ä–∏–Ω—É —Ç–∞–±–ª–∏—Ü—ã, –æ—Å—Ç–∞–ª—å–Ω—ã–º –∫–æ–ª–æ–Ω–∫–∞–º –æ—Å—Ç–∞–≤–ª—è–µ–º auto */
    .cell-ellipsis{
      display:block;
      width:var(--client-col-max);
      max-width:var(--client-col-max);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    tbody tr{background:#fff}
    tbody tr:hover{background:#fafafa}
    .num{font-variant-numeric:tabular-nums; text-align:right}
    .muted{color:var(--muted)}

    /* Order-book style: sells = reddish, buys = greenish (not too bright) */
    td.side-sell{
      background:var(--sell-bg);
      box-shadow: inset 0 0 0 1px var(--sell-border);
    }
    td.side-buy{
      background:var(--buy-bg);
      box-shadow: inset 0 0 0 1px var(--buy-border);
    }
    .checkbox{
      width:28px;
      text-align:center;
      padding-left:6px;
      padding-right:6px;
    }
    .fixed-center{
      text-align:center;
    }
    .touch-col{
      min-width:0;
      width:auto;
      text-align:center;
      padding-left:6px;
      padding-right:6px;
    }

    .touch-col .header-icon{
      font-size:14px;
      width:18px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .kebab{
      width:34px;
      text-align:center;
      color:#9ca3af;
      font-weight:900;
      cursor:pointer;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .bulb{
      width:18px; height:18px;
      border-radius:999px;
      display:grid; place-items:center;
      border:1px solid #fcd34d;
      background:#fffbeb;
      color:#b45309;
      font-size:12px;
      font-weight:900;
    }
    .sr-only{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0, 0, 0, 0);
      white-space:nowrap;
      border:0;
    }
    .tooltip-target{
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .tooltip-target::after{
      content:attr(data-tooltip);
      position:absolute;
      bottom:calc(100% + 8px);
      left:50%;
      transform:translateX(-50%);
      background:#f9fafb;
      color:#111827;
      border:1px solid var(--line);
      border-radius:8px;
      padding:6px 10px;
      font-size:12px;
      font-weight:600;
      box-shadow:0 6px 16px rgba(15,23,42,.12);
      white-space:nowrap;
      opacity:0;
      pointer-events:none;
      transition:opacity .15s ease, transform .15s ease;
    }
    .tooltip-target::before{
      content:"";
      position:absolute;
      bottom:calc(100% + 2px);
      left:50%;
      transform:translateX(-50%) rotate(45deg);
      width:8px;
      height:8px;
      background:#f9fafb;
      border:1px solid var(--line);
      border-top:none;
      border-left:none;
      transform:translateX(-50%) rotate(45deg);
      opacity:0;
      transition:opacity .15s ease, transform .15s ease;
    }
    .tooltip-target:hover::after{
      opacity:1;
      transform:translateX(-50%) translateY(-2px);
    }
    .tooltip-target:hover::before{
      opacity:1;
      transform:translateX(-50%) translateY(-2px) rotate(45deg);
    }
    /* Column filter buttons (Blotter table header) */
    .col-filter-btn{
      position:relative;
      margin-left:6px;
      width:22px;
      height:22px;
      border:1px solid transparent;
      background:transparent;
      border-radius:6px;
      color:var(--muted);
      cursor:pointer;
      display:inline-grid;
      place-items:center;
      font-weight:900;
      line-height:1;
    }
    .col-filter-btn:hover{
      background:#f3f4f6;
      border-color:var(--line);
    }
    .col-filter-btn.active{
      color:var(--blue);
      background:#eff6ff;
      border-color:#bfdbfe;
    }
    .col-filter-btn.active::after{
      content:"";
      position:absolute;
      top:3px;
      right:3px;
      width:6px;
      height:6px;
      border-radius:999px;
      background:var(--blue);
    }
    /* Blotter: sortable headers (all columns) */
    #blotterView th.sortable{
      cursor:pointer;
      user-select:none;
    }
    #blotterView th.sortable:focus-visible{
      outline:2px solid #93c5fd;
      outline-offset:-2px;
      border-radius:6px;
    }
    #blotterView th.sortable .sort-indicator{
      display:inline-block;
      width:12px;           /* keeps header width stable */
      text-align:center;
      margin-left:4px;
      font-size:11px;
      line-height:1;
      color:var(--muted);
      vertical-align:middle;
    }
    #blotterView th.sortable.sorted .sort-indicator{ color:var(--blue); }
    #blotterView th.sortable.sort-asc .sort-indicator::before{ content:"‚ñ≤"; }
    #blotterView th.sortable.sort-desc .sort-indicator::before{ content:"‚ñº"; }

    /* Monitor: show default sort on Rate (non-interactive) */
    #monitorView th.rate-sorted .sort-indicator{
      display:inline-block;
      width:12px;
      text-align:center;
      margin-left:4px;
      font-size:11px;
      line-height:1;
      vertical-align:middle;
      color:var(--blue);
    }
    #monitorView th.rate-sorted .sort-indicator::before{
      content:"‚ñº";
    }
    /* Popover */
    .col-filter-popover{
      position:fixed;
      z-index:1000;
      width:260px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      box-shadow:0 10px 25px rgba(15,23,42,.12);
      padding:10px;
    }
    .col-filter-popover .cf-title{
      font-size:13px;
      font-weight:800;
      margin:0 0 8px 0;
    }
    .col-filter-popover .cf-range{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    .col-filter-popover .cf-actions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:10px;
    }
    .col-filter-popover .cf-actions .btn{
      height:32px;
      font-size:12px;
    }
    /* Column-filter popover checkbox list (shared by Blotter & Monitor) */
    .col-filter-popover .cf-list{
      display:flex;
      flex-direction:column;
      gap:6px;
      max-height:220px;
      overflow:auto;
      border:1px solid var(--line);
      border-radius:10px;
      padding:6px;
      background:#f9fafb;
    }
    .col-filter-popover .cf-item{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 8px;
      border-radius:8px;
      cursor:pointer;
      user-select:none;
      font-size:13px;
      font-weight:600;
      color:#111827;
    }
    .col-filter-popover .cf-item:hover{
      background:#fff;
    }
    .col-filter-popover .cf-item input{
      width:14px;
      height:14px;
      margin:0;
    }
    .col-filter-popover .cf-sep{
      height:1px;
      background:var(--line);
      margin:4px 2px;
    }
    /* Utility */
    .right{margin-left:auto}
    .hidden{display:none !important}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">XIOMA FX</div>
    <nav class="menu">
      <a class="item" href="#">Deals <span class="caret">‚ñæ</span></a>
      <a class="item" href="#">Rates <span class="caret">‚ñæ</span></a>
      <a class="item" href="#">Data <span class="caret">‚ñæ</span></a>
      <a class="item" href="#">Services <span class="caret">‚ñæ</span></a>
      <a class="item" href="#">Audit</a>
    </nav>
    <div class="spacer"></div>
    <div class="user"></div>
  </div>

  <div class="page">
    <div class="card">
      <div class="header">
        <div class="hgroup">
          <h1 class="title">Order Administration</h1>
          <div class="subline">
            <div class="mode-switch" role="tablist" aria-label="Order Administration mode">
              <button class="mode-btn active" type="button" data-mode="monitor" role="tab" aria-selected="true">Monitor</button>
              <button class="mode-btn" type="button" data-mode="blotter" role="tab" aria-selected="false">Blotter</button>
              <button class="mode-btn" type="button" data-mode="history" role="tab" aria-selected="false">History</button>
            </div>
          </div>
        </div>
      </div>

      <div class="content">
        <!-- Left sidebar -->
        <aside class="sidebar" id="currencySidebar">
          <div class="side-title">
            <span class="section-title">Currency Pair</span>
            <span class="icon" title="Refresh">‚ü≥</span>
          </div>
          <div class="pair-list" id="pairList">
            <!-- rendered by JS -->
          </div>
        </aside>

        <!-- Table -->
        <section class="main">
          <div id="monitorView">
            <section class="filters-panel" aria-label="Filters">
              <div class="filters-header">
                <span class="section-title">Filter Toolbar</span>

                <div class="filter-actions">
                  <button class="btn small primary" id="searchBtn">Search</button>
                </div>
              </div>
              <div class="filters-grid">
                <div class="field has-icon">
                  <label>INN</label>
                  <span class="field-icon">üîé</span>
                  <input id="innFilter" class="input with-icon" type="text" placeholder="INN contains..." autocomplete="off" />
                </div>
                <div class="field has-icon">
                  <label>Client Name</label>
                  <span class="field-icon">üîé</span>
                  <input id="clientFilter" class="input with-icon" type="text" placeholder="Client Name contains..." autocomplete="off" />
                </div>
                <div class="field">
                  <label>Min Amount (&gt;=)</label>
                  <input id="amountMin" class="input" type="text" inputmode="decimal" />
                </div>
              </div>
              <div class="filters-divider"></div>
              <div class="applied-bar" aria-live="polite">
                <span class="applied-label">Applied:</span>
                <span id="monitorAppliedFilters" class="applied-text" title="">No filters applied</span>
                <button class="btn small" id="resetBtn">Clear all filters</button>
              </div>
            </section>

            <section class="toolbar-panel" aria-label="Order Toolbar">
              <div class="toolbar-header">
                <span class="section-title">Order Toolbar</span>
              </div>
              <div class="tablebar">
                <div class="toolbar-group">
                  <button class="btn toolbar primary" id="newOrderBtn">Ôºã New Order</button>
                </div>

                <div class="toolbar-group toolbar-selected">
                  <span class="toolbar-label">Selected orders:</span>
                  <button class="btn toolbar ghost" type="button">Convert to Deal</button>
                  <button class="btn toolbar ghost" type="button">Send to NT Pro</button>
                  <button class="btn toolbar ghost" type="button">Send to NT Pro 2</button>
                  <button class="btn toolbar danger" type="button">Cancel Order</button>
                </div>
              </div>
            </section>

            <div class="table-wrap">
              <table class="orders-table">
                <colgroup>
                  <col class="col-checkbox" />
                  <col class="col-captured" />
                  <col class="col-createdby" />
                  <col class="col-inn" />
                  <col class="col-client" />
                  <col class="col-sell" />
                  <col class="col-rate" />
                  <col class="col-touch" />
                  <col class="col-buy" />
                  <col class="col-tif" />
                  <col class="col-valid" />
                  <col class="col-exposure" />
                  <col class="col-status" />
                  <col class="col-actions" />
                </colgroup>
                <thead>
                  <tr>
                    <th class="checkbox fixed-center"><span class="sr-only">Select</span></th>

                    <th class="fixed-center">
                      Create Date
                      <button class="col-filter-btn" type="button"
                              data-monitor-col-filter="createDate"
                              aria-label="Filter Create Date"
                              title="Filter Create Date">
                        <svg class="funnel-icon" viewBox="0 0 24 24" aria-hidden="true">
                          <path d="M3 4h18l-7 8v6l-4 2v-8z"></path>
                        </svg>
                      </button>
                    </th>

                    <th>
                      Created By
                      <button class="col-filter-btn" type="button"
                              data-monitor-col-filter="createdBy"
                              aria-label="Filter Created By"
                              title="Filter Created By">
                        <svg class="funnel-icon" viewBox="0 0 24 24" aria-hidden="true">
                          <path d="M3 4h18l-7 8v6l-4 2v-8z"></path>
                        </svg>
                      </button>
                    </th>
                    <th>INN</th>
                    <th>Client Name</th>

                    <th class="num">Sell Amount</th>
                    <th class="num rate-col rate-sorted">Rate <span class="sort-indicator" aria-hidden="true"></span></th>

                    <th class="touch-col">
                      <span class="header-icon tooltip-target" data-tooltip="Market Touch Indicator" aria-hidden="true">üí°</span>
                      <span class="sr-only">Market Touch Indicator</span>
                    </th>

                    <th class="num">Buy Amount</th>
                    <th class="fixed-center">
                      Time In Force
                      <button class="col-filter-btn" type="button"
                              data-monitor-col-filter="tif"
                              aria-label="Filter Time In Force"
                              title="Filter Time In Force">
                        <svg class="funnel-icon" viewBox="0 0 24 24" aria-hidden="true">
                          <path d="M3 4h18l-7 8v6l-4 2v-8z"></path>
                        </svg>
                      </button>
                    </th>
                    <th class="fixed-center">Valid Till</th>

                    <th>
                      Market Exposure
                      <button class="col-filter-btn" type="button"
                              data-monitor-col-filter="exposure"
                              aria-label="Filter Market Exposure"
                              title="Filter Market Exposure">
                        <svg class="funnel-icon" viewBox="0 0 24 24" aria-hidden="true">
                          <path d="M3 4h18l-7 8v6l-4 2v-8z"></path>
                        </svg>
                      </button>
                    </th>

                    <th>
                      Status
                      <button class="col-filter-btn" type="button"
                              data-monitor-col-filter="status"
                              aria-label="Filter Status"
                              title="Filter Status">
                        <svg class="funnel-icon" viewBox="0 0 24 24" aria-hidden="true">
                          <path d="M3 4h18l-7 8v6l-4 2v-8z"></path>
                        </svg>
                      </button>
                    </th>

                    <th class="kebab"><span class="sr-only">Actions</span></th>
                  </tr>
                </thead>
                <tbody id="tbody">
                  <!-- rows by JS -->
                </tbody>
              </table>
            </div>
          </div>

          <div id="blotterView" class="hidden">
            <section class="filters-panel" aria-label="Blotter Filters">
              <div class="filters-header">
                <span class="section-title">Filter Toolbar</span>

                <div class="filter-actions">
                  <button class="btn small primary" id="blotterSearchBtn">Search</button>
                </div>
              </div>


              <div class="blotter-filters-grid">
                <div class="field has-icon">
                  <label>INN</label>
                  <span class="field-icon">üîé</span>
                  <input id="blInn" class="input with-icon" type="text" placeholder="INN contains..." autocomplete="off" />
                </div>

                <div class="field has-icon">
                  <label>Client Name</label>
                  <span class="field-icon">üîé</span>
                  <input id="blClient" class="input with-icon" type="text" placeholder="Client Name contains..." autocomplete="off" />
                </div>

                <div class="field">
                  <label>Amount Min (&gt;=)</label>
                  <input id="blAmountMin" class="input" type="text" inputmode="decimal" />
                </div>

                <div class="field">
                  <label>Amount Max (&lt;=)</label>
                  <input id="blAmountMax" class="input" type="text" inputmode="decimal" />
                </div>
              </div>

              <div class="filters-divider"></div>
              <div class="applied-bar" aria-live="polite">
                <span class="applied-label">Applied:</span>
                <span id="blotterAppliedFilters" class="applied-text" title="">No filters applied</span>
                <button class="btn small" id="blotterResetBtn">Clear all filters</button>
              </div>
            </section>

            <section class="toolbar-panel" aria-label="Order Toolbar">
              <div class="toolbar-header">
                <span class="section-title">Order Toolbar</span>
              </div>
              <div class="tablebar">
                <div class="toolbar-group">
                  <button class="btn toolbar primary" type="button">Ôºã New Order</button>
                </div>

                <div class="toolbar-group toolbar-selected">
                  <span class="toolbar-label">Selected orders:</span>
                  <button class="btn toolbar ghost" type="button">Convert to Deal</button>
                  <button class="btn toolbar ghost" type="button">Send to NT Pro</button>
                  <button class="btn toolbar ghost" type="button">Send to NT Pro 2</button>
                  <button class="btn toolbar danger" type="button">Cancel Order</button>
                </div>
              </div>
            </section>

            <div class="table-wrap">
              <table class="orders-table" id="blotterTable">
                <colgroup>
                  <col class="col-checkbox" />
                  <col class="col-captured" />
                  <col class="col-createdby" />
                  <col class="col-inn" />
                  <col class="col-client" />
                  <col class="col-pair" />
                  <col class="col-amount" />
                  <col class="col-side" />
                  <col class="col-rate" />
                  <col class="col-touch" />
                  <col class="col-tif" />
                  <col class="col-valid" />
                  <col class="col-exposure" />
                  <col class="col-status" />
                  <col class="col-actions" />
                </colgroup>
                <thead>
                  <tr>
                    <th class="checkbox fixed-center"><span class="sr-only">Select</span></th>
                    <th class="fixed-center sortable" data-bl-sort="createDate" role="button" tabindex="0" aria-sort="descending">
                      Create Date <span class="sort-indicator" aria-hidden="true"></span>
                      <button class="col-filter-btn" type="button"
                              data-col-filter="createDate"
                              aria-label="Filter Create Date"
                              title="Filter Create Date">
                        <svg class="funnel-icon" viewBox="0 0 24 24" aria-hidden="true">
                          <path d="M3 4h18l-7 8v6l-4 2v-8z"></path>
                        </svg>
                      </button>
                    </th>
                    <th class="sortable" data-bl-sort="createdBy" role="button" tabindex="0" aria-sort="none">
                      Created By <span class="sort-indicator" aria-hidden="true"></span>
                      <button class="col-filter-btn" type="button"
                              data-col-filter="createdBy"
                              aria-label="Filter Created By"
                              title="Filter Created By">
                        <svg class="funnel-icon" viewBox="0 0 24 24" aria-hidden="true">
                          <path d="M3 4h18l-7 8v6l-4 2v-8z"></path>
                        </svg>
                      </button>
                    </th>
                    <th class="sortable" data-bl-sort="inn" role="button" tabindex="0" aria-sort="none">
                      INN <span class="sort-indicator" aria-hidden="true"></span>
                    </th>
                    <th class="sortable" data-bl-sort="client" role="button" tabindex="0" aria-sort="none">
                      Client Name <span class="sort-indicator" aria-hidden="true"></span>
                    </th>
                    <th class="sortable" data-bl-sort="pair" role="button" tabindex="0" aria-sort="none">
                      Currency Pair <span class="sort-indicator" aria-hidden="true"></span>
                      <button class="col-filter-btn" type="button"
                              data-col-filter="pair"
                              aria-label="Filter Currency Pair"
                              title="Filter Currency Pair">
                        <svg class="funnel-icon" viewBox="0 0 24 24" aria-hidden="true">
                          <path d="M3 4h18l-7 8v6l-4 2v-8z"></path>
                        </svg>
                      </button>
                    </th>
                    <th class="num sortable" data-bl-sort="amount" role="button" tabindex="0" aria-sort="none">
                      Amount <span class="sort-indicator" aria-hidden="true"></span>
                    </th>
                    <th class="sortable" data-bl-sort="side" role="button" tabindex="0" aria-sort="none">
                      Side <span class="sort-indicator" aria-hidden="true"></span>
                      <button class="col-filter-btn" type="button"
                              data-col-filter="side"
                              aria-label="Filter Side"
                              title="Filter Side">
                        <svg class="funnel-icon" viewBox="0 0 24 24" aria-hidden="true">
                          <path d="M3 4h18l-7 8v6l-4 2v-8z"></path>
                        </svg>
                      </button>
                    </th>
                    <th class="num sortable" data-bl-sort="rate" role="button" tabindex="0" aria-sort="none">
                      Rate <span class="sort-indicator" aria-hidden="true"></span>
                    </th>
                    <th class="touch-col sortable" data-bl-sort="touch" role="button" tabindex="0" aria-sort="none">
                      <span class="header-icon tooltip-target" data-tooltip="Market Touch Indicator" aria-hidden="true">üí°</span>
                      <span class="sort-indicator" aria-hidden="true"></span>
                      <button class="col-filter-btn" type="button"
                              data-col-filter="touch"
                              aria-label="Filter Market Touch"
                              title="Filter Market Touch">
                        <svg class="funnel-icon" viewBox="0 0 24 24" aria-hidden="true">
                          <path d="M3 4h18l-7 8v6l-4 2v-8z"></path>
                        </svg>
                      </button>
                      <span class="sr-only">Market Touch Indicator</span>
                    </th>
                    <th class="fixed-center sortable" data-bl-sort="tif" role="button" tabindex="0" aria-sort="none">
                      Time In Force <span class="sort-indicator" aria-hidden="true"></span>
                      <button class="col-filter-btn" type="button"
                              data-col-filter="tif"
                              aria-label="Filter Time In Force"
                              title="Filter Time In Force">
                        <svg class="funnel-icon" viewBox="0 0 24 24" aria-hidden="true">
                          <path d="M3 4h18l-7 8v6l-4 2v-8z"></path>
                        </svg>
                      </button>
                    </th>
                    <th class="fixed-center sortable" data-bl-sort="valid" role="button" tabindex="0" aria-sort="none">
                      Valid Till <span class="sort-indicator" aria-hidden="true"></span>
                    </th>
                    <th class="sortable" data-bl-sort="exposure" role="button" tabindex="0" aria-sort="none">
                      Market Exposure <span class="sort-indicator" aria-hidden="true"></span>
                      <button class="col-filter-btn" type="button"
                              data-col-filter="exposure"
                              aria-label="Filter Market Exposure"
                              title="Filter Market Exposure">
                        <svg class="funnel-icon" viewBox="0 0 24 24" aria-hidden="true">
                          <path d="M3 4h18l-7 8v6l-4 2v-8z"></path>
                        </svg>
                      </button>
                    </th>
                    <th class="sortable" data-bl-sort="status" role="button" tabindex="0" aria-sort="none">
                      Status <span class="sort-indicator" aria-hidden="true"></span>
                      <button class="col-filter-btn" type="button"
                              data-col-filter="status"
                              aria-label="Filter Status"
                              title="Filter Status">
                        <svg class="funnel-icon" viewBox="0 0 24 24" aria-hidden="true">
                          <path d="M3 4h18l-7 8v6l-4 2v-8z"></path>
                        </svg>
                      </button>
                    </th>
                    <th class="kebab"><span class="sr-only">Actions</span></th>
                  </tr>
                </thead>
                <tbody id="blotterTbody">
                  <!-- rows by JS -->
                </tbody>
              </table>
            </div>
          </div>

          <div id="historyView" class="hidden">
            <section class="filters-panel" aria-label="History">
              <div class="filters-header">
                <span class="section-title">History</span>
              </div>
              <div class="muted" style="padding:4px 2px;">
                History mode is a placeholder. No behavior implemented yet.
              </div>
            </section>
          </div>
        </section>
      </div>
    </div>
  </div>

  <div id="blotterColFilterPopover" class="col-filter-popover hidden" role="dialog" aria-label="Column filter"></div>
  <div id="monitorColFilterPopover" class="col-filter-popover hidden" role="dialog" aria-label="Column filter"></div>

  <script>
    // ------- Demo data -------
    const pairCodes = ["USDRUB", "EURRUB", "CNYRUB"];
    const CREATED_BY_OPTIONS = ["dealer1", "dealer2", "some_process1", "some_process2"];
    const STATUS_OPTIONS = ["New", "Delegated", "Execute Pending", "Executed", "Cancelled"];
    const TIF_OPTIONS = ["GTC", "GTD"];

    const rows = [
      mkRow({pair:"USDRUB", captured:"05.06.2025, 11:15", client:'–û–û–û "–†–æ–º–∞—à–∫–∞"', valid:"06.06.2025, 09:30", sell:null, rate:77.80000, buy:15000000, mt:null, exec:"NT Pro"}),
      mkRow({pair:"USDRUB", captured:"05.06.2025, 13:46", client:'–û–û–û "Neotinea tridentata (Scop.) R.M.Bateman, Pridgeon & M.W.Chase"', tif:"GTC", valid:null, sell:8000000, rate:78.00000, buy:null, mt:null, exec:"NT Pro"}),
      mkRow({pair:"USDRUB", captured:"05.06.2025, 10:25", client:'–û–û–û "–ú–∞–∫"', tif:"GTC", valid:null, sell:4500000, rate:78.50000, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"USDRUB", captured:"05.06.2025, 12:05", client:'–û–û–û "–í–∞—Å–∏–ª–µ–∫"', valid:"06.06.2025, 11:45", sell:300000, rate:78.13000, buy:null, mt:null, exec:"NT Pro"}),
      mkRow({pair:"USDRUB", captured:"05.06.2025, 10:40", client:'–û–û–û "–ö–∞–∫—Ç—É—Å"', valid:"05.06.2025, 16:05", sell:null, rate:77.70000, buy:17000000, mt:null, exec:"NT Pro"}),
      mkRow({pair:"USDRUB", captured:"05.06.2025, 10:05", client:'–û–û–û "–ö–∞–∫—Ç—É—Å"', valid:"05.06.2025, 14:20", sell:null, rate:77.65000, buy:30000000, mt:null, exec:"Traders"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 10:43", client:'–û–û–û "–†–æ–º–∞—à–∫–∞"', valid:"06.06.2025, 03:15", sell:null, rate:91.00649, buy:8937869, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 12:54", client:'–û–û–û "–†–æ–∑–∞"', valid:"05.06.2025, 16:58", sell:null, rate:91.05002, buy:9328452, mt:null, exec:"NT Pro"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 11:02", client:'–û–û–û "–í–µ—Ä–±–µ–Ω–∞"', valid:"06.06.2025, 16:58", sell:null, rate:91.06420, buy:10684847, mt:null, exec:"Traders"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 11:49", client:'–û–û–û "–õ–æ—Ç–æ—Å"', valid:"05.06.2025, 21:35", sell:null, rate:91.13238, buy:19131404, mt:null, exec:"Traders"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 12:34", client:'–û–û–û "–°—Ç—Ä–µ–ª–∏—Ü–∏—è"', valid:"05.06.2025, 15:27", sell:null, rate:91.17131, buy:16407133, mt:null, exec:"Traders"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 12:19", client:'–û–û–û "–ë–∞—Ä–≤–∏–Ω–æ–∫"', valid:"06.06.2025, 06:18", sell:null, rate:91.18182, buy:1680963, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 11:51", client:'–û–û–û "–ò—Ä–∏—Å"', valid:"05.06.2025, 18:48", sell:null, rate:91.18865, buy:14563677, mt:null, exec:"Traders"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 12:58", client:'–û–û–û "–ì–≤–æ–∑–¥–∏–∫–∞"', valid:"06.06.2025, 12:31", sell:null, rate:91.19684, buy:13609728, mt:null, exec:"NT Pro"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 12:55", client:'–û–û–û "–ú–∞–∫"', valid:"06.06.2025, 01:19", sell:null, rate:91.22310, buy:14688301, mt:null, exec:"Traders"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 12:05", client:'–û–û–û "–§–∏–∞–ª–∫–∞"', valid:"06.06.2025, 07:37", sell:null, rate:91.24965, buy:12801506, mt:null, exec:"Traders"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 10:58", client:'–û–û–û "–õ–∏–ª–∏—è"', valid:"06.06.2025, 06:37", sell:null, rate:91.26462, buy:19261026, mt:null, exec:"NT Pro"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 11:06", client:'–û–û–û "–¢—é–ª—å–ø–∞–Ω"', valid:"05.06.2025, 19:15", sell:null, rate:91.27908, buy:3539167, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 12:55", client:'–û–û–û "–ö–ª–µ–≤–µ—Ä"', valid:"06.06.2025, 05:38", sell:null, rate:91.28574, buy:4785216, mt:null, exec:"NT Pro"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 12:46", client:'–û–û–û "–ù–∞—Å—Ç—É—Ä—Ü–∏—è"', valid:"05.06.2025, 20:01", sell:null, rate:91.30568, buy:5520686, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 11:32", client:'–û–û–û "–û—Ä—Ö–∏–¥–µ—è"', valid:"05.06.2025, 21:40", sell:null, rate:91.31096, buy:11394238, mt:null, exec:"NT Pro"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 12:53", client:'–û–û–û "–ì–ª–∞–¥–∏–æ–ª—É—Å"', valid:"06.06.2025, 02:11", sell:null, rate:91.32531, buy:12020906, mt:null, exec:"Traders"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 11:49", client:'–û–û–û "–ê—Å—Ç—Ä–∞"', valid:"05.06.2025, 13:58", sell:null, rate:91.32927, buy:172322, mt:null, exec:"NT Pro"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 12:46", client:'–û–û–û "–ì–∏–∞—Ü–∏–Ω—Ç"', valid:"06.06.2025, 11:54", sell:null, rate:91.34228, buy:8314491, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 12:16", client:'–û–û–û "–í–∞—Å–∏–ª–µ–∫"', valid:"06.06.2025, 16:02", sell:null, rate:91.35730, buy:3670554, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 12:12", client:'–û–û–û "–ì–∏–∞—Ü–∏–Ω—Ç"', valid:"05.06.2025, 17:52", sell:null, rate:91.37980, buy:7404829, mt:null, exec:"NT Pro"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 10:08", client:'–û–û–û "–ü–∏–æ–Ω"', valid:"05.06.2025, 13:33", sell:null, rate:91.43728, buy:17056909, mt:null, exec:"NT Pro"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 11:39", client:'–û–û–û "–†–∞–Ω—É–Ω–∫—É–ª—é—Å"', valid:"05.06.2025, 22:51", sell:null, rate:91.47890, buy:8182309, mt:"bulb", exec:"Traders"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 12:37", client:'–û–û–û "–ü–∏–æ–Ω"', valid:"06.06.2025, 05:50", sell:null, rate:91.48599, buy:15970338, mt:"bulb", exec:"NT Pro"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 11:33", client:'–û–û–û "–ù–∞—Ä—Ü–∏—Å—Å"', valid:"06.06.2025, 09:33", sell:1557954, rate:91.52904, buy:null, mt:"bulb", exec:"NT Pro"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 10:57", client:'–û–û–û "–ñ–∞—Å–º–∏–Ω"', valid:"06.06.2025, 11:22", sell:2495870, rate:91.53396, buy:null, mt:null, exec:"NT Pro"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 12:20", client:'–û–û–û "–¢—é–ª—å–ø–∞–Ω"', valid:"05.06.2025, 21:01", sell:16387807, rate:91.55695, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 11:55", client:'–û–û–û "–ù–∞—Ä—Ü–∏—Å—Å"', valid:"05.06.2025, 18:37", sell:8482113, rate:91.55709, buy:null, mt:null, exec:"Traders"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 11:02", client:'–û–û–û "–ö–∞–º–µ–ª–∏—è"', valid:"06.06.2025, 15:12", sell:2777374, rate:91.57878, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 10:21", client:'–û–û–û "–ì–µ—Ä–±–µ—Ä–∞"', valid:"06.06.2025, 06:28", sell:12234457, rate:91.58636, buy:null, mt:null, exec:"Traders"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 10:59", client:'–û–û–û "–ö–∞–ª–µ–Ω–¥—É–ª–∞"', valid:"06.06.2025, 11:56", sell:1976966, rate:91.64857, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 11:01", client:'–û–û–û "–ö–æ—Å–º–µ—è"', valid:"05.06.2025, 13:22", sell:19840364, rate:91.67617, buy:null, mt:null, exec:"Traders"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 10:44", client:'–û–û–û "–°–∏—Ä–µ–Ω—å"', valid:"06.06.2025, 03:35", sell:18788132, rate:91.75891, buy:null, mt:null, exec:"NT Pro"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 10:27", client:'–û–û–û "–õ–∞–≤–∞–Ω–¥–∞"', valid:"05.06.2025, 13:51", sell:12145349, rate:91.75985, buy:null, mt:null, exec:"NT Pro"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 11:03", client:'–û–û–û "–ê—Å—Ç—Ä–∞"', valid:"05.06.2025, 14:45", sell:15313925, rate:91.76025, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 12:42", client:'–û–û–û "–ö–∞–º–ø–∞–Ω—É–ª–∞"', valid:"05.06.2025, 15:02", sell:15805148, rate:91.76953, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 11:36", client:'–û–û–û "–•—Ä–∏–∑–∞–Ω—Ç–µ–º–∞"', valid:"06.06.2025, 03:03", sell:1917683, rate:91.82220, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 11:54", client:'–û–û–û "–•—Ä–∏–∑–∞–Ω—Ç–µ–º–∞"', valid:"05.06.2025, 19:57", sell:9434531, rate:91.89842, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 11:59", client:'–û–û–û "–ë—É–∑–∏–Ω–∞"', valid:"06.06.2025, 06:51", sell:8418332, rate:91.90297, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 10:35", client:'–û–û–û "–¶–∏–∫–ª–∞–º–µ–Ω"', valid:"06.06.2025, 10:37", sell:18548347, rate:91.95056, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 10:45", client:'–û–û–û "–ö–∞–º–µ–ª–∏—è"', valid:"06.06.2025, 01:34", sell:7272169, rate:91.97128, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 12:43", client:'–û–û–û "–ü—Ä–∏–º—É–ª–∞"', valid:"06.06.2025, 00:32", sell:3853657, rate:91.97721, buy:null, mt:null, exec:"NT Pro"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 10:45", client:'–û–û–û "–®–∞—Ñ—Ä–∞–Ω"', valid:"05.06.2025, 20:25", sell:14298153, rate:92.05535, buy:null, mt:null, exec:"Traders"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 10:18", client:'–û–û–û "–§—Ä–µ–∑–∏—è"', valid:"06.06.2025, 14:01", sell:4319822, rate:92.06541, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 10:52", client:'–û–û–û "–õ–∞–≤–∞–Ω–¥–∞"', valid:"05.06.2025, 17:48", sell:4803737, rate:92.07257, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 12:44", client:'–û–û–û "–ò—Ä–∏—Å"', valid:"05.06.2025, 13:43", sell:18385201, rate:92.12249, buy:null, mt:null, exec:"Traders"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 11:07", client:'–û–û–û "–ö—Ä–æ–∫—É—Å"', valid:"06.06.2025, 14:15", sell:8916145, rate:92.12274, buy:null, mt:null, exec:"Traders"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 12:31", client:'–û–û–û "–õ–æ—Ç–æ—Å"', valid:"05.06.2025, 20:54", sell:341284, rate:92.17688, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 12:28", client:'–û–û–û "–õ–∏–ª–∏—è"', valid:"05.06.2025, 15:39", sell:1166449, rate:92.18099, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 10:29", client:'–û–û–û "–ì–æ—Ä—Ç–µ–Ω–∑–∏—è"', valid:"05.06.2025, 16:04", sell:14265337, rate:92.25489, buy:null, mt:null, exec:"NT Pro"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 10:19", client:'–û–û–û "–ú—è—Ç–∞"', valid:"06.06.2025, 12:06", sell:7782011, rate:92.26221, buy:null, mt:null, exec:"NT Pro"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 10:26", client:'–û–û–û "–ì–µ—Ä–±–µ—Ä–∞"', valid:"05.06.2025, 12:18", sell:18239121, rate:92.30429, buy:null, mt:null, exec:"NT Pro"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 11:25", client:'–û–û–û "–ü–æ–¥—Å–æ–ª–Ω—É—Ö"', valid:"05.06.2025, 19:11", sell:13375203, rate:92.31088, buy:null, mt:null, exec:"NT Pro"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 11:17", client:'–û–û–û "–ñ–∞—Å–º–∏–Ω"', valid:"06.06.2025, 02:42", sell:18748490, rate:92.39318, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 12:37", client:'–û–û–û "–ú–∞–≥–Ω–æ–ª–∏—è"', valid:"05.06.2025, 19:38", sell:1637611, rate:92.40914, buy:null, mt:null, exec:"NT Pro"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 10:57", client:'–û–û–û "–≠–¥–µ–ª—å–≤–µ–π—Å"', valid:"06.06.2025, 06:36", sell:6849509, rate:92.51053, buy:null, mt:null, exec:"NT Pro"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 10:01", client:'–û–û–û "–ì–≤–æ–∑–¥–∏–∫–∞"', valid:"06.06.2025, 13:40", sell:14280586, rate:92.61164, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 10:20", client:'–û–û–û "–§–∏–∞–ª–∫–∞"', valid:"06.06.2025, 02:29", sell:18565853, rate:92.61604, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 12:50", client:'–û–û–û "–û–¥—É–≤–∞–Ω—á–∏–∫"', valid:"05.06.2025, 23:43", sell:17134339, rate:92.68334, buy:null, mt:null, exec:"NT Pro"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 10:18", client:'–û–û–û "–†–æ–∑–∞"', valid:"05.06.2025, 11:28", sell:2477578, rate:92.71927, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 11:32", client:'–û–û–û "–û—Ä—Ö–∏–¥–µ—è"', valid:"06.06.2025, 16:42", sell:8443522, rate:92.72335, buy:null, mt:null, exec:"Traders"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 10:31", client:'–û–û–û "–õ–∞–Ω–¥—ã—à"', valid:"06.06.2025, 11:21", sell:9053167, rate:92.76958, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 12:39", client:'–û–û–û "–ê–Ω–µ–º–æ–Ω–∞"', valid:"06.06.2025, 04:16", sell:13501657, rate:92.79565, buy:null, mt:null, exec:"NT Pro"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 12:27", client:'–û–û–û "–ü–µ—Ç—É–Ω–∏—è"', valid:"06.06.2025, 16:49", sell:119189, rate:92.84487, buy:null, mt:null, exec:"NT Pro"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 10:04", client:'–û–û–û "–ú–∞–≥–Ω–æ–ª–∏—è"', valid:"05.06.2025, 13:28", sell:8031579, rate:92.85273, buy:null, mt:null, exec:"Traders"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 11:46", client:'–û–û–û "–ì–ª–∞–¥–∏–æ–ª—É—Å"', valid:"05.06.2025, 21:26", sell:15367547, rate:92.85304, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 12:24", client:'–û–û–û "–ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫"', valid:"05.06.2025, 21:34", sell:485239, rate:92.94216, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 11:25", client:'–û–û–û "–ê–ª—å—Å—Ç—Ä–æ–º–µ—Ä–∏—è"', valid:"06.06.2025, 01:57", sell:12629912, rate:92.99030, buy:null, mt:null, exec:"NT Pro"}),
      mkRow({pair:"EURRUB", captured:"05.06.2025, 11:38", client:'–û–û–û "–ë–µ–≥–æ–Ω–∏—è"', valid:"05.06.2025, 19:38", sell:4741643, rate:92.99465, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 10:02", client:'–û–û–û "–†–æ–∑–∞"', valid:"05.06.2025, 12:10", sell:null, rate:11.00250, buy:5500000, mt:null, exec:"None"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 10:08", client:'–û–û–û "–õ–∏–ª–∏—è"', valid:"05.06.2025, 16:40", sell:null, rate:11.02500, buy:25000000, mt:null, exec:"Traders"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 10:15", client:'–û–û–û "–¢—é–ª—å–ø–∞–Ω"', valid:"05.06.2025, 13:55", sell:null, rate:11.04750, buy:1200000, mt:null, exec:"NT Pro"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 10:22", client:'–û–û–û "–û—Ä—Ö–∏–¥–µ—è"', valid:"06.06.2025, 09:20", sell:null, rate:11.06000, buy:80000000, mt:null, exec:"Traders"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 10:29", client:'–û–û–û "–ü–∏–æ–Ω"', valid:"05.06.2025, 14:05", sell:null, rate:11.07250, buy:15500000, mt:null, exec:"None"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 10:34", client:'–û–û–û "–õ–∞–≤–∞–Ω–¥–∞"', valid:"06.06.2025, 11:30", sell:null, rate:11.08500, buy:35000000, mt:null, exec:"Traders"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 10:41", client:'–û–û–û "–ñ–∞—Å–º–∏–Ω"', valid:"05.06.2025, 15:25", sell:null, rate:11.09750, buy:900000, mt:null, exec:"NT Pro"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 10:47", client:'–û–û–û "–ì–µ—Ä–±–µ—Ä–∞"', valid:"06.06.2025, 13:15", sell:null, rate:11.11000, buy:60000000, mt:null, exec:"Traders"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 10:53", client:'–û–û–û "–ê—Å—Ç—Ä–∞"', valid:"05.06.2025, 17:00", sell:null, rate:11.12250, buy:12300000, mt:null, exec:"None"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 10:58", client:'–û–û–û "–§–∏–∞–ª–∫–∞"', valid:"06.06.2025, 08:40", sell:null, rate:11.13500, buy:22500000, mt:null, exec:"Traders"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 11:05", client:'–û–û–û "–ö–∞–º–µ–ª–∏—è"', valid:"05.06.2025, 12:45", sell:null, rate:11.14000, buy:18000000, mt:null, exec:"NT Pro"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 11:12", client:'–û–û–û "–ì–≤–æ–∑–¥–∏–∫–∞"', valid:"06.06.2025, 16:10", sell:null, rate:11.14250, buy:42000000, mt:null, exec:"Traders"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 11:18", client:'–û–û–û "–•—Ä–∏–∑–∞–Ω—Ç–µ–º–∞"', valid:"05.06.2025, 18:20", sell:null, rate:11.14500, buy:7000000, mt:null, exec:"None"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 11:23", client:'–û–û–û "–ò—Ä–∏—Å"', valid:"06.06.2025, 10:05", sell:null, rate:11.14750, buy:19500000, mt:"bulb", exec:"NT Pro"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 11:28", client:'–û–û–û "–õ–æ—Ç–æ—Å"', valid:"06.06.2025, 14:30", sell:30000000, rate:11.15250, buy:null, mt:"bulb", exec:"Traders"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 11:34", client:'–û–û–û "–ù–∞—Ä—Ü–∏—Å—Å"', valid:"05.06.2025, 16:05", sell:8500000, rate:11.16500, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 11:39", client:'–û–û–û "–ì–∏–∞—Ü–∏–Ω—Ç"', valid:"06.06.2025, 09:55", sell:55000000, rate:11.17750, buy:null, mt:null, exec:"Traders"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 11:45", client:'–û–û–û "–ö—Ä–æ–∫—É—Å"', valid:"05.06.2025, 19:10", sell:14000000, rate:11.19000, buy:null, mt:null, exec:"NT Pro"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 11:50", client:'–û–û–û "–ü–æ–¥—Å–æ–ª–Ω—É—Ö"', valid:"06.06.2025, 15:40", sell:26000000, rate:11.20250, buy:null, mt:null, exec:"Traders"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 11:56", client:'–û–û–û "–ë–µ–≥–æ–Ω–∏—è"', valid:"06.06.2025, 17:00", sell:100000000, rate:11.21500, buy:null, mt:null, exec:"Traders"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 12:02", client:'–û–û–û "–ö–∞–ª–µ–Ω–¥—É–ª–∞"', valid:"05.06.2025, 16:50", sell:3000000, rate:11.22750, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 12:07", client:'–û–û–û "–°–∏—Ä–µ–Ω—å"', valid:"06.06.2025, 12:20", sell:48000000, rate:11.24000, buy:null, mt:null, exec:"Traders"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 12:12", client:'–û–û–û "–ú–∞–≥–Ω–æ–ª–∏—è"', valid:"05.06.2025, 18:45", sell:18500000, rate:11.25250, buy:null, mt:null, exec:"NT Pro"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 12:18", client:'–û–û–û "–õ–∞–Ω–¥—ã—à"', valid:"06.06.2025, 07:25", sell:21000000, rate:11.26500, buy:null, mt:null, exec:"Traders"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 12:24", client:'–û–û–û "–ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫"', valid:"05.06.2025, 15:55", sell:6500000, rate:11.27750, buy:null, mt:null, exec:"None"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 12:31", client:'–û–û–û "–ü—Ä–∏–º—É–ª–∞"', valid:"06.06.2025, 11:05", sell:32000000, rate:11.29000, buy:null, mt:null, exec:"Traders"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 12:37", client:'–û–û–û "–ê–Ω–µ–º–æ–Ω–∞"', valid:"05.06.2025, 19:35", sell:16200000, rate:11.29750, buy:null, mt:null, exec:"NT Pro"}),
      mkRow({pair:"CNYRUB", captured:"05.06.2025, 12:44", client:'–û–û–û "–ü–µ—Ç—É–Ω–∏—è"', valid:"06.06.2025, 13:50", sell:45000000, rate:11.30000, buy:null, mt:null, exec:"Traders"}),
      mkRow({pair:"USDRUB", captured:"05.06.2025, 12:50", client:'–û–û–û "–û–¥—É–≤–∞–Ω—á–∏–∫"', valid:"06.06.2025, 16:20", sell:10000000, rate:78.20000, buy:null, mt:null, exec:"Traders"}),
    ];

    function mkRow({pair, captured, client, valid, sell, rate, buy, mt, exec, tif}){
      // TIF: "GTC" => Valid Till must be null; "GTD" => Valid Till must be a date/time string
      const timeInForce = tif || (valid ? "GTD" : "GTC");
      const validTill = (timeInForce === "GTC") ? null : valid;
      return { pair, captured, client, tif: timeInForce, valid: validTill, sell, rate, buy, mt, exec, id: cryptoRandomId() };
    }

    function cryptoRandomId(){
      // not cryptographic; just demo
      return Math.random().toString(16).slice(2,10);
    }

    // ------- Rendering -------
    const pairListEl = document.getElementById('pairList');
    const tbody = document.getElementById('tbody');
    const blotterTbody = document.getElementById('blotterTbody');
    const clientFilterInput = document.getElementById('clientFilter');
    const innFilterInput = document.getElementById('innFilter');
    const amountMinInput = document.getElementById('amountMin');
    const monitorAppliedFilters = document.getElementById('monitorAppliedFilters');
    const blClient = document.getElementById('blClient');
    const blInn = document.getElementById('blInn');
    const blAmountMin = document.getElementById('blAmountMin');
    const blAmountMax = document.getElementById('blAmountMax');

    [amountMinInput, blAmountMin, blAmountMax].forEach(input => {
      if (!input) return;
      input.addEventListener('blur', () => formatAmountInput(input));
      input.addEventListener('change', () => formatAmountInput(input));
    });

    const blotterSearchBtn = document.getElementById('blotterSearchBtn');
    const blotterResetBtn = document.getElementById('blotterResetBtn');
    const blotterAppliedFilters = document.getElementById('blotterAppliedFilters');
    const blotterColFilterPopover = document.getElementById('blotterColFilterPopover');
    let openedColFilterKey = null;

    let activePair = pairCodes[0];
    let filtered = [...rows];
    const exposureOptions = [...new Set(rows.map(row => row.exec).filter(Boolean))];
    // Column filters now support multi-select (Set). Empty Set = "All"
    const blotterColFilters = {
      pair: new Set(),
      createdBy: new Set(),
      side: new Set(),
      touch: new Set(),
      exposure: new Set(),
      tif: new Set(),
      status: new Set()
    };
    // Monitor header column-filters (checkbox UI; stored as Set. Empty Set = "All")
    const monitorColFilters = {
      createDate: new Set(),
      createdBy: new Set(),
      touch: new Set(),
      exposure: new Set(),
      tif: new Set(),
      status: new Set()
    };
    // Date-range filters for Create Date (stored as ISO YYYY-MM-DD)
    const blotterRangeFilters = { createDateFrom: "", createDateTo: "" };
    const monitorRangeFilters = { createDateFrom: "", createDateTo: "" };
    // Blotter sorting (embedded in table header). Default: latest first.
    let blotterSort = { key: "createDate", dir: "desc" };

    const monitorColFilterPopover = document.getElementById('monitorColFilterPopover');
    let openedMonitorColFilterKey = null;

    function getPairsWithCounts(){
      return pairCodes.map(code => ({
        code,
        count: rows.filter(row => row.pair === code).length,
        hasMarketTouch: rows.some(row => row.pair === code && isMarketTouch(row))
      }));
    }

    function renderPairs(){
      pairListEl.innerHTML = "";
      getPairsWithCounts().forEach(p => {
        const el = document.createElement('div');
        el.className = "pair" + (p.code === activePair ? " active" : "");
        el.innerHTML = `
          <span class="pair-info">
            <span class="code">${p.code}</span>
            ${p.hasMarketTouch ? `<span class="bulb tooltip-target" data-tooltip="Market Touch">üí°</span>` : ``}
          </span>
          <span class="count">${p.count}</span>
        `;
        el.addEventListener('click', () => {
          activePair = p.code;
          renderPairs();
          applyFilters();
        });
        pairListEl.appendChild(el);
      });
    }

    function fmtNum(n){
      if (n === null || n === undefined) return "";
      return formatAmountValue(n);
    }

    const amountFormatter = new Intl.NumberFormat("ru-RU", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
    const eurRubRateFormatter = new Intl.NumberFormat("ru-RU", {
      minimumFractionDigits: 4,
      maximumFractionDigits: 4
    });

    function formatAmountValue(value){
      if (value === null || value === undefined || Number.isNaN(value)) return "";
      return amountFormatter.format(value).replace(/\u00A0/g, " ");
    }

    function normalizeAmountInput(value){
      return value.toString().replace(/[\s\u00A0]/g, "");
    }

    function formatAmountInput(input){
      if (!input) return;
      const parsed = parseOptionalNumber(input.value);
      input.value = parsed === null ? "" : formatAmountValue(parsed);
    }

    function fmtRate(n, pair){
      if (n === null || n === undefined) return "";
      if (pair === "EURRUB"){
        const rounded = Math.round(n * 100) / 100;
        return eurRubRateFormatter.format(rounded);
      }
      return n.toFixed(5);
    }

    function updateBlotterAppliedFiltersSummary(model){
      if (!blotterAppliedFilters) return;

      const parts = [];
      if (model.capFrom || model.capTo){
        const fromText = yyyyMmDdToDdMmYyyy(model.capFrom);
        const toText = yyyyMmDdToDdMmYyyy(model.capTo);
        if (model.capFrom && model.capTo) parts.push(`Create Date=${fromText}..${toText}`);
        else if (model.capFrom) parts.push(`Create Date‚â•${fromText}`);
        else parts.push(`Create Date‚â§${toText}`);
      }
      const pairText = summarizeSet(model.pair);
      if (pairText) parts.push(`Currency Pair=${pairText}`);

      const createdByText = summarizeSet(model.createdByNeedle);
      if (createdByText) parts.push(`Created By=${createdByText}`);
      if (model.clientNeedleRaw) parts.push(`Client Name~"${model.clientNeedleRaw}"`);
      if (model.innNeedle) parts.push(`INN~"${model.innNeedle}"`);

      if (model.amountMin !== null || model.amountMax !== null){
        if (model.amountMin !== null && model.amountMax !== null){
          parts.push(`Amount=${fmtNum(model.amountMin)}..${fmtNum(model.amountMax)}`);
        } else if (model.amountMin !== null){
          parts.push(`Amount‚â•${fmtNum(model.amountMin)}`);
        } else {
          parts.push(`Amount‚â§${fmtNum(model.amountMax)}`);
        }
      }

      const sideText = summarizeSet(model.sideNeedle);
      if (sideText) parts.push(`Side=${sideText}`);

      const touchText = summarizeSet(model.touchNeedle, v => (v === "yes" ? "Yes" : "No"));
      if (touchText) parts.push(`Market Touch=${touchText}`);

      const exposureText = summarizeSet(model.exposureNeedle);
      if (exposureText) parts.push(`Market Exposure=${exposureText}`);

      const tifText = summarizeSet(model.tifNeedle);
      if (tifText) parts.push(`Time In Force=${tifText}`);

      const statusText = summarizeSet(model.statusNeedle);
      if (statusText) parts.push(`Status=${statusText}`);

      const summary = parts.length ? parts.join(" | ") : "No filters applied";
      blotterAppliedFilters.textContent = summary;
      blotterAppliedFilters.title = summary;
      blotterAppliedFilters.classList.toggle('is-empty', !parts.length);
    }

    function hashString(s){
      let h = 0;
      for (let i = 0; i < s.length; i++){
        h = (h * 31 + s.charCodeAt(i)) >>> 0;
      }
      return h;
    }

    function innForClient(client){
      const h = hashString(client);
      // 10 digits: "77" + 8 digits
      return "77" + String(h % 100000000).padStart(8, "0");
    }

    function createdByForRow(r){
      const h = hashString(`${r.client}|${r.pair}`);
      return CREATED_BY_OPTIONS[h % CREATED_BY_OPTIONS.length];
    }

    function statusForRow(r){
      const h = hashString(`${r.client}|${r.pair}|${r.captured}|${r.valid}`);
      return STATUS_OPTIONS[h % STATUS_OPTIONS.length];
    }

    function getAmountAndSide(r){
      if (r.buy !== null && r.buy !== undefined) return { amount: r.buy, side: "buy" };
      if (r.sell !== null && r.sell !== undefined) return { amount: r.sell, side: "sell" };
      return { amount: null, side: "" };
    }

    // ------- Blotter sorting -------
    function ruDateTimeToTs(value){
      if (!value) return null;
      // "05.06.2025, 11:15"
      const parts = value.split(",");
      if (parts.length < 2) return null;
      const dmy = parts[0].trim();
      const hm = parts[1].trim();
      const dmyParts = dmy.split(".");
      const hmParts = hm.split(":");
      if (dmyParts.length !== 3 || hmParts.length !== 2) return null;
      const [d, m, y] = dmyParts.map(n => Number(n));
      const [hh, mm] = hmParts.map(n => Number(n));
      if (![d, m, y, hh, mm].every(Number.isFinite)) return null;
      const ts = new Date(y, m - 1, d, hh, mm).getTime();
      return Number.isFinite(ts) ? ts : null;
    }

    function normalizeRateForSort(rate, pair){
      if (rate === null || rate === undefined) return null;
      // IMPORTANT: EURRUB is displayed rounded to 2dp (then formatted to 4),
      // so sort by that same rounded value to avoid "visually equal but reordered" rows.
      if (pair === "EURRUB") return Math.round(rate * 100) / 100;
      return rate;
    }

    function getBlotterSortValue(r, key){
      if (!r) return null;
      if (key === "createDate") return ruDateTimeToTs(r.captured);
      if (key === "createdBy") return createdByForRow(r);
      if (key === "inn") return innForClient(r.client);
      if (key === "client") return r.client || "";
      if (key === "pair") return r.pair || "";
      if (key === "amount") return getAmountAndSide(r).amount;
      if (key === "side") return getAmountAndSide(r).side || "";
      if (key === "valid") return ruDateTimeToTs(r.valid); // null -> nulls last
      if (key === "rate") return normalizeRateForSort(r.rate, r.pair);
      if (key === "touch") return isMarketTouch(r) ? 1 : 0;
      if (key === "tif") return r.tif || "";
      if (key === "exposure") return r.exec || "";
      if (key === "status") return statusForRow(r) || "";
      return null;
    }

    function sortBlotterRows(source){
      const key = blotterSort.key;
      const dir = blotterSort.dir === "asc" ? 1 : -1;

      const indexed = (source || []).map((r, idx) => ({ r, idx }));
      indexed.sort((a, b) => {
        const av = getBlotterSortValue(a.r, key);
        const bv = getBlotterSortValue(b.r, key);

        const aNull = (av === null || av === undefined || Number.isNaN(av));
        const bNull = (bv === null || bv === undefined || Number.isNaN(bv));

        // nulls last regardless of direction (especially important for Valid Till when TIF=GTC)
        if (aNull && bNull) return a.idx - b.idx;
        if (aNull) return 1;
        if (bNull) return -1;

        if (av < bv) return -1 * dir;
        if (av > bv) return 1 * dir;
        return a.idx - b.idx; // stable tie-breaker
      });
      return indexed.map(x => x.r);
    }

    function updateBlotterSortIndicators(){
      document.querySelectorAll('#blotterView th.sortable[data-bl-sort]').forEach(th => {
        const key = th.dataset.blSort;
        const isActive = key === blotterSort.key;

        th.classList.toggle('sorted', isActive);
        th.classList.toggle('sort-asc', isActive && blotterSort.dir === "asc");
        th.classList.toggle('sort-desc', isActive && blotterSort.dir === "desc");

        th.setAttribute('aria-sort', isActive
          ? (blotterSort.dir === "asc" ? "ascending" : "descending")
          : "none"
        );
      });
    }

    function setBlotterSort(key){
      if (!key) return;

      if (blotterSort.key === key){
        blotterSort.dir = blotterSort.dir === "asc" ? "desc" : "asc";
      } else {
        blotterSort.key = key;
        blotterSort.dir = (key === "createDate") ? "desc" : "asc";
      }
      applyBlotterFilters();
    }

    function renderBlotterTable(data){
      if (!blotterTbody) return;

      blotterTbody.innerHTML = "";
      const source = data || rows;
      source.forEach(r => {
        const { amount, side } = getAmountAndSide(r);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="checkbox"><input type="checkbox" /></td>

          <td class="fixed-center">${r.captured}</td>
          <td class="muted">${createdByForRow(r)}</td>
          <td class="muted">${innForClient(r.client)}</td>
          <td class="client-name">
            <span class="cell-ellipsis">${r.client}</span>
          </td>

          <td><strong>${r.pair}</strong></td>

          <td class="num ${side === 'sell' ? 'side-sell' : (side === 'buy' ? 'side-buy' : '')}">${fmtNum(amount)}</td>

          <td>${side}</td>

          <td class="num rate-col">${fmtRate(r.rate, r.pair)}</td>

          <td class="touch-col">
            ${r.mt === "bulb"
              ? `<span class="badge"><span class="bulb tooltip-target" data-tooltip="Market Touch Indicator">üí°</span></span>`
              : ``}
          </td>

          <td class="fixed-center">${r.tif || ""}</td>
          <td class="fixed-center">${r.valid || ""}</td>

          <td class="muted">${r.exec}</td>

          <td>${statusForRow(r)}</td>

          <td class="kebab" title="More">‚ãÆ</td>
        `;
        // tooltip: –ø–æ–ª–Ω–æ–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
        const clientSpan = tr.querySelector('.client-name .cell-ellipsis');
        if (clientSpan) clientSpan.title = r.client;
        blotterTbody.appendChild(tr);
      });
    }

    function parseAmount(value){
      if (!value) return 0;
      const normalized = normalizeAmountInput(value).replace(/[^\d.,-]/g, "").replace(",", ".");
      const parsed = Number.parseFloat(normalized);
      return Number.isFinite(parsed) ? parsed : 0;
    }

    function summarizeSet(set, mapFn){
      if (!set || set.size === 0) return "";
      const arr = Array.from(set).map(v => (mapFn ? mapFn(v) : v));
      return arr.length === 1 ? arr[0] : `${arr[0]}+${arr.length - 1}`;
    }

    function getBlotterColFilterMeta(){
      return {
        createDate: { type: "dateRange", label: "Create Date" },
        pair: { label: "Currency Pair", options: pairCodes.map(v => ({ value: v, label: v })) },
        createdBy: { label: "Created By", options: CREATED_BY_OPTIONS.map(v => ({ value: v, label: v })) },
        side: { label: "Side", options: ["buy", "sell"].map(v => ({ value: v, label: v })) },
        touch: { label: "Market Touch", options: [{ value: "yes", label: "Yes" }, { value: "no", label: "No" }] },
        exposure: { label: "Market Exposure", options: exposureOptions.map(v => ({ value: v, label: v })) },
        tif: { label: "Time In Force", options: TIF_OPTIONS.map(v => ({ value: v, label: v })) },
        status: { label: "Status", options: STATUS_OPTIONS.map(v => ({ value: v, label: v })) }
      };
    }

    function updateBlotterColFilterIndicators(){
      document.querySelectorAll('.col-filter-btn[data-col-filter]').forEach(btn => {
        const key = btn.dataset.colFilter;
        // Create Date is a dateRange filter, its single source of truth is blotterRangeFilters.
        if (key === "createDate"){
          const isActive = !!(blotterRangeFilters.createDateFrom || blotterRangeFilters.createDateTo);
          btn.classList.toggle('active', isActive);
          return;
        }
        const set = blotterColFilters[key];
        const isActive = (set instanceof Set && set.size > 0);
        btn.classList.toggle('active', !!isActive);
      });
    }

    function closeBlotterColFilterPopover(){
      blotterColFilterPopover.classList.add('hidden');
      blotterColFilterPopover.innerHTML = "";
      openedColFilterKey = null;
    }

    function openBlotterColFilterPopover(key, anchorEl){
      const meta = getBlotterColFilterMeta()[key];
      if (!meta) return;

      openedColFilterKey = key;

      if (meta.type === "dateRange"){
        blotterColFilterPopover.innerHTML = `
          <div class="cf-title">${meta.label}</div>
          <div class="cf-range">
            <div class="field">
              <label>From</label>
              <input id="cfDateFrom" class="input" type="date" />
            </div>
            <div class="field">
              <label>To</label>
              <input id="cfDateTo" class="input" type="date" />
            </div>
          </div>
          <div class="cf-actions">
            <button class="btn small" type="button" id="cfClearBtn">Clear</button>
            <button class="btn small primary" type="button" id="cfApplyBtn">Apply</button>
          </div>
        `;

        // position
        const rect = anchorEl.getBoundingClientRect();
        const pad = 8;
        const width = 260;
        let left = rect.left;
        if (left + width + pad > window.innerWidth) left = window.innerWidth - width - pad;
        if (left < pad) left = pad;
        let top = rect.bottom + pad;
        const heightGuess = 220;
        if (top + heightGuess + pad > window.innerHeight) top = rect.top - heightGuess - pad;
        if (top < pad) top = pad;
        blotterColFilterPopover.style.left = `${left}px`;
        blotterColFilterPopover.style.top = `${top}px`;
        blotterColFilterPopover.classList.remove('hidden');

        const fromEl = document.getElementById("cfDateFrom");
        const toEl = document.getElementById("cfDateTo");
        fromEl.value = blotterRangeFilters.createDateFrom || "";
        toEl.value = blotterRangeFilters.createDateTo || "";

        document.getElementById("cfClearBtn").onclick = () => {
          fromEl.value = "";
          toEl.value = "";
        };

        document.getElementById("cfApplyBtn").onclick = () => {
          let from = fromEl.value;
          let to = toEl.value;
          if (from && to && from > to){ const tmp = from; from = to; to = tmp; } // normalize

          blotterRangeFilters.createDateFrom = from;
          blotterRangeFilters.createDateTo = to;

          updateBlotterColFilterIndicators();
          closeBlotterColFilterPopover();
          applyBlotterFilters();
        };

        return;
      }

      // Draft selection: –Ω–µ –º—É—Ç–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –ø–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–∂–∞–ª Apply
      const draft = new Set(blotterColFilters[key]);

      blotterColFilterPopover.innerHTML = `
        <div class="cf-title">${meta.label}</div>

        <div class="cf-list" id="cfList">
          ${meta.options.map(o => `
            <label class="cf-item">
              <input type="checkbox" value="${o.value}" ${draft.has(o.value) ? "checked" : ""} />
              <span>${o.label}</span>
            </label>
          `).join("")}
        </div>

        <div class="cf-actions">
          <button class="btn small" type="button" id="cfClearBtn">Clear</button>
          <button class="btn small primary" type="button" id="cfApplyBtn">Apply</button>
        </div>
      `;

      // --- –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ), –Ω–æ "guess" —á—É—Ç—å –±–æ–ª—å—à–µ –∏–∑-–∑–∞ —Å–ø–∏—Å–∫–∞ ---
      const rect = anchorEl.getBoundingClientRect();
      const pad = 8;
      const width = 260;

      let left = rect.left;
      if (left + width + pad > window.innerWidth) left = window.innerWidth - width - pad;
      if (left < pad) left = pad;

      let top = rect.bottom + pad;
      const heightGuess = 280; // –±—ã–ª–æ ~160, —Ç–µ–ø–µ—Ä—å —Å–ø–∏—Å–æ–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã—à–µ
      if (top + heightGuess + pad > window.innerHeight) top = rect.top - heightGuess - pad;
      if (top < pad) top = pad;

      blotterColFilterPopover.style.left = `${left}px`;
      blotterColFilterPopover.style.top = `${top}px`;
      blotterColFilterPopover.classList.remove('hidden');

      // --- wiring —á–µ–∫–±–æ–∫—Å–æ–≤ ---
      const checkboxes = blotterColFilterPopover.querySelectorAll('input[type="checkbox"]');

      checkboxes.forEach(cb => {
        cb.addEventListener('change', () => {
          if (cb.checked) draft.add(cb.value);
          else draft.delete(cb.value);
        });
      });

      document.getElementById('cfClearBtn').onclick = () => {
        draft.clear();
        checkboxes.forEach(cb => { cb.checked = false; });
      };

      document.getElementById('cfApplyBtn').onclick = () => {
        // –í–∞–∂–Ω–∞—è UX-–¥–µ—Ç–∞–ª—å:
        // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ—Ç–∏–ª –í–°–ï –∑–Ω–∞—á–µ–Ω–∏—è ‚Äî —ç—Ç–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ "All",
        // –ø–æ—ç—Ç–æ–º—É –æ—á–∏—â–∞–µ–º Set (–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –ø–æ–≥–∞—Å–Ω–µ—Ç).
        const isAllSelected = draft.size === meta.options.length;

        const target = blotterColFilters[key]; // —ç—Ç–æ Set (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Å—Ç–∞–Ω—Å)
        target.clear();

        if (!isAllSelected){
          draft.forEach(v => target.add(v));
        }

        updateBlotterColFilterIndicators();
        closeBlotterColFilterPopover();
        applyBlotterFilters();
      };
    }

    function getMonitorColFilterMeta(){
      return {
        createDate: { type: "dateRange", label: "Create Date" },
        createdBy: { label: "Created By", options: CREATED_BY_OPTIONS.map(v => ({ value: v, label: v })) },
        touch: {
          label: "Market Touch",
          options: [{ value: "yes", label: "Yes" }, { value: "no", label: "No" }]
        },
        exposure: {
          label: "Market Exposure",
          options: exposureOptions.map(v => ({ value: v, label: v }))
        },
        tif: { label: "Time In Force", options: TIF_OPTIONS.map(v => ({ value: v, label: v })) },
        status: { label: "Status", options: STATUS_OPTIONS.map(v => ({ value: v, label: v })) }
      };
    }

    function updateMonitorColFilterIndicators(){
      document.querySelectorAll('.col-filter-btn[data-monitor-col-filter]').forEach(btn => {
        const key = btn.dataset.monitorColFilter;
        const set = monitorColFilters[key];
        const isActive =
          (set instanceof Set && set.size > 0)
          || (key === "createDate" && (monitorRangeFilters.createDateFrom || monitorRangeFilters.createDateTo));
        btn.classList.toggle('active', !!isActive);
      });
    }

    function closeMonitorColFilterPopover(){
      monitorColFilterPopover.classList.add('hidden');
      monitorColFilterPopover.innerHTML = "";
      openedMonitorColFilterKey = null;
    }

    function openMonitorColFilterPopover(key, anchorEl){
      const meta = getMonitorColFilterMeta()[key];
      if (!meta) return;

      openedMonitorColFilterKey = key;

      if (meta.type === "dateRange"){
        monitorColFilterPopover.innerHTML = `
          <div class="cf-title">${meta.label}</div>
          <div class="cf-range">
            <div class="field">
              <label>From</label>
              <input id="mcfDateFrom" class="input" type="date" />
            </div>
            <div class="field">
              <label>To</label>
              <input id="mcfDateTo" class="input" type="date" />
            </div>
          </div>
          <div class="cf-actions">
            <button class="btn small" type="button" id="mcfClearBtn">Clear</button>
            <button class="btn small primary" type="button" id="mcfApplyBtn">Apply</button>
          </div>
        `;

        const rect = anchorEl.getBoundingClientRect();
        const pad = 8;
        const width = 260;
        let left = rect.left;
        if (left + width + pad > window.innerWidth) left = window.innerWidth - width - pad;
        if (left < pad) left = pad;
        let top = rect.bottom + pad;
        const heightGuess = 220;
        if (top + heightGuess + pad > window.innerHeight) top = rect.top - heightGuess - pad;
        if (top < pad) top = pad;
        monitorColFilterPopover.style.left = `${left}px`;
        monitorColFilterPopover.style.top = `${top}px`;
        monitorColFilterPopover.classList.remove('hidden');

        const fromEl = document.getElementById("mcfDateFrom");
        const toEl = document.getElementById("mcfDateTo");
        fromEl.value = monitorRangeFilters.createDateFrom || "";
        toEl.value = monitorRangeFilters.createDateTo || "";

        document.getElementById("mcfClearBtn").onclick = () => {
          fromEl.value = "";
          toEl.value = "";
        };

        document.getElementById("mcfApplyBtn").onclick = () => {
          let from = fromEl.value;
          let to = toEl.value;
          if (from && to && from > to){ const tmp = from; from = to; to = tmp; }

          monitorRangeFilters.createDateFrom = from;
          monitorRangeFilters.createDateTo = to;

          updateMonitorColFilterIndicators();
          closeMonitorColFilterPopover();
          applyFilters();
        };

        return;
      }

      const listHtml = meta.options.map(o => `
        <label class="cf-item">
          <input type="checkbox" class="mcf-opt" value="${o.value}">
          <span>${o.label}</span>
        </label>
      `).join("");

      // IMPORTANT: —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ id, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å blotter popover
      monitorColFilterPopover.innerHTML = `
        <div class="cf-title">${meta.label}</div>

        <div class="cf-list">
          <label class="cf-item">
            <input type="checkbox" id="mcfAll">
            <span>All</span>
          </label>

          <div class="cf-sep"></div>

          ${listHtml}
        </div>

        <div class="cf-actions">
          <button class="btn small" type="button" id="mcfClearBtn">Clear</button>
          <button class="btn small primary" type="button" id="mcfApplyBtn">Apply</button>
        </div>
      `;

      const rect = anchorEl.getBoundingClientRect();
      const pad = 8;
      const width = 260;

      let left = rect.left;
      if (left + width + pad > window.innerWidth) left = window.innerWidth - width - pad;
      if (left < pad) left = pad;

      let top = rect.bottom + pad;
      const heightGuess = 320;
      if (top + heightGuess + pad > window.innerHeight) top = rect.top - heightGuess - pad;
      if (top < pad) top = pad;

      monitorColFilterPopover.style.left = `${left}px`;
      monitorColFilterPopover.style.top = `${top}px`;
      monitorColFilterPopover.classList.remove('hidden');

      // --- init UI state from Set ---
      const allCb = monitorColFilterPopover.querySelector("#mcfAll");
      const optCbs = Array.from(monitorColFilterPopover.querySelectorAll(".mcf-opt"));
      const currentSet = monitorColFilters[key];

      // If Set is empty -> "All" (no filter)
      if (currentSet.size === 0){
        allCb.checked = true;
        optCbs.forEach(cb => cb.checked = false);
      } else {
        allCb.checked = false;
        optCbs.forEach(cb => cb.checked = currentSet.has(cb.value));

        // safeguard: if all options checked, treat as "All"
        if (optCbs.length > 0 && optCbs.every(cb => cb.checked)){
          allCb.checked = true;
          optCbs.forEach(cb => cb.checked = false);
        }
      }

      // --- behavior: All vs options ---
      allCb.addEventListener("change", () => {
        if (allCb.checked){
          optCbs.forEach(cb => cb.checked = false);
        }
      });

      optCbs.forEach(cb => {
        cb.addEventListener("change", () => {
          if (cb.checked) allCb.checked = false;

          // if all unchecked, return to All
          const anyChecked = optCbs.some(x => x.checked);
          if (!anyChecked){
            allCb.checked = true;
          }
        });
      });

      // Clear = return UI to "All" (no auto-apply)
      document.getElementById("mcfClearBtn").onclick = () => {
        allCb.checked = true;
        optCbs.forEach(cb => cb.checked = false);
      };

      // Apply = persist selection to Set and filter
      document.getElementById("mcfApplyBtn").onclick = () => {
        const selected = optCbs.filter(cb => cb.checked).map(cb => cb.value);
        const total = optCbs.length;

        // Normalize: All / none / all selected => "no filter" => empty Set
        const treatAsAll = allCb.checked || selected.length === 0 || (total > 0 && selected.length === total);

        const targetSet = monitorColFilters[key];
        targetSet.clear();
        if (!treatAsAll){
          selected.forEach(v => targetSet.add(v));
        }

        updateMonitorColFilterIndicators();
        closeMonitorColFilterPopover();
        applyFilters();
      };
    }

    function yyyyMmDdToDdMmYyyy(value){
      if (!value) return "";
      const parts = value.split("-");
      if (parts.length !== 3) return "";
      const [y, m, d] = parts;
      return `${d}.${m}.${y}`;
    }

    function capturedToIsoDate(captured){
      if (!captured) return "";
      // "05.06.2025, 11:15" -> "2025-06-05"
      const dmy = captured.split(",")[0].trim();
      const parts = dmy.split(".");
      if (parts.length !== 3) return "";
      const [d, m, y] = parts;
      return `${y}-${m}-${d}`;
    }

    function inIsoDateRange(isoDate, from, to){
      if (!from && !to) return true;
      if (!isoDate) return false;
      if (from && isoDate < from) return false;
      if (to && isoDate > to) return false;
      return true;
    }

    function parseOptionalNumber(value){
      if (!value || !value.toString().trim()) return null;
      const normalized = normalizeAmountInput(value).replace(/[^\d.,-]/g, "").replace(",", ".");
      const parsed = Number.parseFloat(normalized);
      return Number.isFinite(parsed) ? parsed : null;
    }

    function isRowAboveMin(r, minAmount){
      if (!minAmount) return true;
      const { amount } = getAmountAndSide(r);
      return amount !== null && amount !== undefined && amount >= minAmount;
    }

    function isMarketTouch(r){
      return r.mt === "bulb";
    }

    function renderTable(){
      tbody.innerHTML = "";
      filtered.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="checkbox"><input type="checkbox" /></td>

          <td class="fixed-center">${r.captured}</td>
          <td class="muted">${createdByForRow(r)}</td>
          <td class="muted">${innForClient(r.client)}</td>
          <td class="client-name">
            <span class="cell-ellipsis">${r.client}</span>
          </td>

          <td class="num ${r.sell !== null && r.sell !== undefined ? 'side-sell' : ''}">${fmtNum(r.sell)}</td>
          <td class="num rate-col">${fmtRate(r.rate, r.pair)}</td>

          <td class="touch-col">
            ${r.mt === "bulb"
              ? `<span class="badge"><span class="bulb tooltip-target" data-tooltip="Market Touch Indicator">üí°</span></span>`
              : ``}
          </td>

          <td class="num ${r.buy !== null && r.buy !== undefined ? 'side-buy' : ''}">${fmtNum(r.buy)}</td>
          <td class="fixed-center">${r.tif || ""}</td>
          <td class="fixed-center">${r.valid || ""}</td>

          <td class="muted">${r.exec}</td>
          <td>${statusForRow(r)}</td>

          <td class="kebab" title="More">‚ãÆ</td>
        `;
        // tooltip: –ø–æ–ª–Ω–æ–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
        const clientSpan = tr.querySelector('.client-name .cell-ellipsis');
        if (clientSpan) clientSpan.title = r.client;
        tbody.appendChild(tr);
      });
    }

    function applyBlotterFilters(){
      const capFrom = blotterRangeFilters.createDateFrom;
      const capTo = blotterRangeFilters.createDateTo;
      const pair = blotterColFilters.pair;              // Set
      const createdByNeedle = blotterColFilters.createdBy; // Set

      const clientNeedleRaw = blClient.value.trim();
      const clientNeedle = clientNeedleRaw.toLowerCase();
      const innNeedle = blInn.value.trim();

      const amountMin = parseOptionalNumber(blAmountMin.value);
      const amountMax = parseOptionalNumber(blAmountMax.value);

      const sideNeedle = blotterColFilters.side;        // Set

      const touchNeedle = blotterColFilters.touch;      // Set
      const exposureNeedle = blotterColFilters.exposure;// Set
      const tifNeedle = blotterColFilters.tif;          // Set

      const statusNeedle = blotterColFilters.status;    // Set

      updateBlotterAppliedFiltersSummary({
        capFrom,
        capTo,
        pair,
        createdByNeedle,
        clientNeedleRaw,
        innNeedle,
        amountMin,
        amountMax,
        sideNeedle,
        touchNeedle,
        exposureNeedle,
        tifNeedle,
        statusNeedle
      });

      const filteredBlotter = rows.filter(r => {
        const { amount, side } = getAmountAndSide(r);

        const createdBy = createdByForRow(r);
        const inn = innForClient(r.client);
        const status = statusForRow(r);

        const okCapture = inIsoDateRange(capturedToIsoDate(r.captured), capFrom, capTo);
        const okPair = pair.size === 0 || pair.has(r.pair);
        const okCreatedBy = createdByNeedle.size === 0 || createdByNeedle.has(createdBy);

        const okClient = !clientNeedle || r.client.toLowerCase().includes(clientNeedle);
        const okInn = !innNeedle || inn.includes(innNeedle);

        const okAmountMin = amountMin === null || (amount !== null && amount >= amountMin);
        const okAmountMax = amountMax === null || (amount !== null && amount <= amountMax);

        const okSide = sideNeedle.size === 0 || sideNeedle.has(side);

        const okTouch =
          touchNeedle.size === 0
          || (touchNeedle.has("yes") && isMarketTouch(r))
          || (touchNeedle.has("no") && !isMarketTouch(r));

        const okExposure = exposureNeedle.size === 0 || exposureNeedle.has(r.exec);
        const okTif = tifNeedle.size === 0 || tifNeedle.has(r.tif);

        const okStatus = statusNeedle.size === 0 || statusNeedle.has(status);

        return (
          okCapture &&
          okPair &&
          okCreatedBy &&
          okClient &&
          okInn &&
          okAmountMin &&
          okAmountMax &&
          okSide &&
          okTouch &&
          okExposure &&
          okTif &&
          okStatus
        );
      });

      const sortedBlotter = sortBlotterRows(filteredBlotter);
      updateBlotterSortIndicators();
      renderBlotterTable(sortedBlotter);
      updateSelectedOrderActions();
    }

    function updateMonitorAppliedFiltersSummary(){
      if (!monitorAppliedFilters) return;

      const parts = [];

      if (activePair) parts.push(`Currency Pair=${activePair}`);

      if (monitorRangeFilters.createDateFrom || monitorRangeFilters.createDateTo){
        const fromText = yyyyMmDdToDdMmYyyy(monitorRangeFilters.createDateFrom);
        const toText = yyyyMmDdToDdMmYyyy(monitorRangeFilters.createDateTo);
        if (monitorRangeFilters.createDateFrom && monitorRangeFilters.createDateTo){
          parts.push(`Create Date=${fromText}..${toText}`);
        } else if (monitorRangeFilters.createDateFrom){
          parts.push(`Create Date‚â•${fromText}`);
        } else {
          parts.push(`Create Date‚â§${toText}`);
        }
      }

      const clientRaw = clientFilterInput.value.trim();
      if (clientRaw) parts.push(`Client Name~"${clientRaw}"`);

      const innRaw = innFilterInput.value.trim();
      if (innRaw) parts.push(`INN~"${innRaw}"`);

      const minAmount = parseAmount(amountMinInput.value);
      if (minAmount) parts.push(`Min Amount‚â•${fmtNum(minAmount)}`);

      const touchText = summarizeSet(monitorColFilters.touch, v => (v === "yes" ? "Yes" : "No"));
      if (touchText) parts.push(`Market Touch=${touchText}`);

      const exposureText = summarizeSet(monitorColFilters.exposure);
      if (exposureText) parts.push(`Market Exposure=${exposureText}`);

      const tifText = summarizeSet(monitorColFilters.tif);
      if (tifText) parts.push(`Time In Force=${tifText}`);

      const createdByText = summarizeSet(monitorColFilters.createdBy);
      if (createdByText) parts.push(`Created By=${createdByText}`);

      const statusText = summarizeSet(monitorColFilters.status);
      if (statusText) parts.push(`Status=${statusText}`);

      const summary = parts.length ? parts.join(" | ") : "No filters applied";
      monitorAppliedFilters.textContent = summary;
      monitorAppliedFilters.title = summary;
      monitorAppliedFilters.classList.toggle('is-empty', !parts.length);
    }

    // ------- Filters -------
    function applyFilters(){
      if (!activePair) {
        activePair = pairCodes[0];
      }
      const clientNeedle = clientFilterInput.value.trim().toLowerCase();
      const innNeedle = innFilterInput.value.trim();
      const minAmount = parseAmount(amountMinInput.value);
      const capFrom = monitorRangeFilters.createDateFrom;
      const capTo = monitorRangeFilters.createDateTo;
      const createdByNeedle = monitorColFilters.createdBy;
      const touchNeedle = monitorColFilters.touch;      // Set
      const exposureNeedle = monitorColFilters.exposure;// Set
      const tifNeedle = monitorColFilters.tif;          // Set
      const statusNeedle = monitorColFilters.status;
      filtered = rows.filter(r => {
        const createdBy = createdByForRow(r);
        const status = statusForRow(r);
        const okPair = r.pair === activePair;
        const inn = innForClient(r.client);
        const okInn = !innNeedle || inn.includes(innNeedle);
        const okClient = !clientNeedle || r.client.toLowerCase().includes(clientNeedle);
        const okAmount = isRowAboveMin(r, minAmount);
        const okCreateDate = inIsoDateRange(capturedToIsoDate(r.captured), capFrom, capTo);
        const okCreatedBy = createdByNeedle.size === 0 || createdByNeedle.has(createdBy);
        const okTouch =
          touchNeedle.size === 0
          || (touchNeedle.has("yes") && isMarketTouch(r))
          || (touchNeedle.has("no") && !isMarketTouch(r));
        const okExposure =
          exposureNeedle.size === 0
          || exposureNeedle.has(r.exec);
        const okTif = tifNeedle.size === 0 || tifNeedle.has(r.tif);
        const okStatus = statusNeedle.size === 0 || statusNeedle.has(status);
        return okPair && okInn && okClient && okAmount && okCreateDate && okCreatedBy && okTouch && okExposure && okTif && okStatus;
      });
      // Monitor: default sorting by Rate (DESC), cannot be changed in UI
      filtered.sort((a, b) => {
        const av = normalizeRateForSort(a.rate, a.pair);
        const bv = normalizeRateForSort(b.rate, b.pair);
        const aNull = (av === null || av === undefined || Number.isNaN(av));
        const bNull = (bv === null || bv === undefined || Number.isNaN(bv));
        if (aNull && bNull) return 0;
        if (aNull) return 1;
        if (bNull) return -1;
        if (av < bv) return 1;
        if (av > bv) return -1;
        return 0;
      });

      renderPairs();
      renderTable();
      updateMonitorAppliedFiltersSummary();
      updateSelectedOrderActions();
    }

    function bindEnterToSearch(panelSelector, onSearch){
      const panel = document.querySelector(panelSelector);
      if (!panel) return;

      panel.addEventListener('keydown', (e) => {
        if (e.key !== 'Enter') return;

        const t = e.target;
        if (!t) return;

        const isInput = t.tagName === 'INPUT';
        const isSelect = t.tagName === 'SELECT';
        if (!isInput && !isSelect) return;

        e.preventDefault();
        onSearch();
      });
    }

    document.getElementById('searchBtn').addEventListener('click', applyFilters);
    document.getElementById('resetBtn').addEventListener('click', () => {
      monitorRangeFilters.createDateFrom = "";
      monitorRangeFilters.createDateTo = "";
      clientFilterInput.value = "";
      innFilterInput.value = "";
      amountMinInput.value = "";
      monitorColFilters.createdBy.clear();
      monitorColFilters.touch.clear();
      monitorColFilters.exposure.clear();
      monitorColFilters.tif.clear();
      monitorColFilters.status.clear();
      updateMonitorColFilterIndicators();
      closeMonitorColFilterPopover();
      applyFilters();
    });

    // ------- Mode switch: Monitor / Blotter / History -------
    const modeButtons = Array.from(document.querySelectorAll('.mode-btn[data-mode]'));
    const contentEl = document.querySelector('.content');
    const currencySidebar = document.getElementById('currencySidebar');
    const monitorView = document.getElementById('monitorView');
    const blotterView = document.getElementById('blotterView');
    const historyView = document.getElementById('historyView');
    let currentMode = "monitor";

    // --- Selected orders toolbar: enable actions only when at least one row is selected ---
    const selectedOrderActionButtons = {
      monitor: Array.from(document.querySelectorAll('#monitorView .toolbar-selected button')),
      blotter: Array.from(document.querySelectorAll('#blotterView .toolbar-selected button'))
    };

    function getSelectedOrdersCount(mode){
      const bodyEl = mode === "monitor" ? tbody : blotterTbody;
      if (!bodyEl) return 0;
      return bodyEl.querySelectorAll('input[type="checkbox"]:checked').length;
    }

    function updateSelectedOrderActions(){
      const hasSelection = getSelectedOrdersCount(currentMode) > 0;
      Object.entries(selectedOrderActionButtons).forEach(([mode, buttons]) => {
        const shouldEnable = (mode === currentMode) && hasSelection;
        buttons.forEach(btn => btn.disabled = !shouldEnable);
      });
    }

    // event delegation (tbody stays the same element even after re-render)
    tbody.addEventListener('change', (e) => {
      if (e.target && e.target.matches('input[type="checkbox"]')){
        updateSelectedOrderActions();
      }
    });

    blotterTbody.addEventListener('change', (e) => {
      if (e.target && e.target.matches('input[type="checkbox"]')){
        updateSelectedOrderActions();
      }
    });

    function setMode(mode){
      currentMode = mode;

      closeBlotterColFilterPopover();
      closeMonitorColFilterPopover();

      modeButtons.forEach(btn => {
        const isActive = btn.dataset.mode === mode;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-selected', isActive ? "true" : "false");
      });

      const isMonitor = mode === "monitor";

      // Layout: show/hide sidebar + stretch main area
      currencySidebar.classList.toggle('hidden', !isMonitor);
      contentEl.classList.toggle('no-sidebar', !isMonitor);

      monitorView.classList.toggle('hidden', mode !== "monitor");
      blotterView.classList.toggle('hidden', mode !== "blotter");
      historyView.classList.toggle('hidden', mode !== "history");

      if (mode === "monitor") applyFilters();
      if (mode === "blotter") applyBlotterFilters();
      updateSelectedOrderActions();
    }

    modeButtons.forEach(btn => {
      btn.addEventListener('click', () => setMode(btn.dataset.mode));
    });

    // Init
    updateBlotterColFilterIndicators();
    updateMonitorColFilterIndicators();
    updateBlotterSortIndicators();
    setMode("monitor");
    updateSelectedOrderActions();

    document.querySelectorAll('.col-filter-btn[data-col-filter]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const key = btn.dataset.colFilter;

        if (!blotterColFilterPopover.classList.contains('hidden') && openedColFilterKey === key){
          closeBlotterColFilterPopover();
          return;
        }
        openBlotterColFilterPopover(key, btn);
      });
    });

    document.querySelectorAll('.col-filter-btn[data-monitor-col-filter]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const key = btn.dataset.monitorColFilter;

        if (!monitorColFilterPopover.classList.contains('hidden') && openedMonitorColFilterKey === key){
          closeMonitorColFilterPopover();
          return;
        }
        openMonitorColFilterPopover(key, btn);
      });
    });

    // ------- Blotter: header sorting bindings -------
    document.querySelectorAll('#blotterView th.sortable[data-bl-sort]').forEach(th => {
      th.addEventListener('click', (e) => {
        // Clicking the filter button (or its SVG path) must not trigger sorting
        if (e.target && e.target.closest && e.target.closest('.col-filter-btn')) return;
        setBlotterSort(th.dataset.blSort);
      });

      th.addEventListener('keydown', (e) => {
        if (e.key === "Enter" || e.key === " "){
          e.preventDefault();
          setBlotterSort(th.dataset.blSort);
        }
      });
    });

    document.addEventListener('click', (e) => {
      // Blotter popover
      if (!blotterColFilterPopover.classList.contains('hidden')){
        const isBlotterBtn = e.target.closest('.col-filter-btn[data-col-filter]');
        const inBlotter = blotterColFilterPopover.contains(e.target);
        if (!isBlotterBtn && !inBlotter) closeBlotterColFilterPopover();
      }

      // Monitor popover
      if (!monitorColFilterPopover.classList.contains('hidden')){
        const isMonitorBtn = e.target.closest('.col-filter-btn[data-monitor-col-filter]');
        const inMonitor = monitorColFilterPopover.contains(e.target);
        if (!isMonitorBtn && !inMonitor) closeMonitorColFilterPopover();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === "Escape"){
        closeBlotterColFilterPopover();
        closeMonitorColFilterPopover();
      }
    });

    bindEnterToSearch('#monitorView .filters-panel', applyFilters);
    bindEnterToSearch('#blotterView .filters-panel', applyBlotterFilters);

    blotterSearchBtn.addEventListener('click', applyBlotterFilters);
    blotterResetBtn.addEventListener('click', () => {
      blotterColFilters.pair.clear();
      blotterColFilters.createdBy.clear();
      blotterColFilters.side.clear();
      blotterColFilters.touch.clear();
      blotterColFilters.exposure.clear();
      blotterColFilters.tif.clear();
      blotterColFilters.status.clear();
      blotterRangeFilters.createDateFrom = "";
      blotterRangeFilters.createDateTo = "";
      updateBlotterColFilterIndicators();
      closeBlotterColFilterPopover();
      blClient.value = "";
      blInn.value = "";
      blAmountMin.value = "";
      blAmountMax.value = "";
      applyBlotterFilters();
    });
  </script>
</body>
</html>
